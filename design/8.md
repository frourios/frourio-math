# フルーリオ代数学 LEAN4実装 第8フェーズ設計書（P5 詳細）

バージョン: 1.0
対象期間: Phase P5（Doob 変換／Young 等号剛性／Dirac 指数）
担当: 開発/形式化チーム

## 0. 目的とスコープ

- 目的: 論文パート（3, 5, 6）の要点を Lean で扱うための骨格を用意し、最小限の厳密ステートメント/補題を配置する。
- スコープ:
  - Doob 変換（Γ–Γ₂ の補正式）: まずは Euclid 空間の形式微分レベル、あるいは抽象 Dirichlet 形式での恒等式スケルトン。
  - Young 畳み込み L2 不等式と等号剛性: G=ℝ, ℤ のケースを優先、Fourier 利用の等号条件を形式化。
  - Dirac 指数の不変性（0 次有界摂動）と T^2 での指数公式の骨子。
- 非スコープ: 厳密幾何（多様体・ベクトル束）/測度論の重厚な証明は次フェーズ以降。ここでは API とレイアウトを固める。

## 1. 現状とギャップ

- 現状: P0–P4 の代数・解析フレームは整備中。EVI/Mosco スケルトン（P4）は別設計。
- ギャップ:
  - Doob: Γ, Γ₂ を Lean で扱う下準備がない（勾配/ヘッセの記号的扱い）。
  - Young: L2 畳み込みの等号剛性（位相整合）の定理が未構成。Fourier・測度の接続が必要。
  - Dirac: 指数公式の型付け（トーラス、ユニタリ接続、Fredholm）が heavy。

## 2. 成果物（Deliverables）

- D1: Doob 変換スケルトン
  - モジュール: `Frourio/Analysis/DoobTransform.lean`
  - Γ, Γ₂ の抽象定義（演算子 L とエネルギー）か、R^n 上の形式微分版のどちらか（切替可能に設計）。
  - 主要ステートメント（Euclid 版／抽象版）:
    - `Gamma^h = Gamma`（`L^h := h⁻¹ L (h·)`）
    - `Gamma2^h = Gamma2 - 2 ⟨∇^2 log h ∇f, ∇f⟩`
  - CD(λ,∞) のパラメータ変換 `Ric_V → Ric_{V-2 log h}` の表記レベルの命題。

- D2: Young 畳み込み L2 不等式と等号剛性
  - モジュール: `Frourio/Analysis/YoungConvolution.lean`
  - 総変動有限測度 `ν` に対し、`∥f * ν∥₂ ≤ ∥f∥₂ ∥ν∥_{TV}`（G=ℝ と ℤ のいずれも）。
  - 等号剛性: `∃ f ≠ 0` で等号 ⇔ `∀ f` で等号 ⇔ `ν = e^{iφ} δ_{s0}`。
  - Fourier を介した等号条件（三角不等式の等号）を Lean 化（位相整合の補題）。

- D3: Dirac 指数の骨子（仕様ファイル）
  - モジュール: `Frourio/Geometry/DiracIndex.lean`
  - ステートメント:
    - 0 次有界摂動で指数不変（ノルム連続同倫）。
    - T^2 での指数公式 `ind D_F^A = (1/2πi)∬ Tr F_{θτ}`（境界なし、補正 0）。
  - 現段階は型/定義の雛形と文書化中心。証明は将来の拡張に委譲。

## 3. 仕様（API/補題の型：案）

- D1: Doob 変換
  - 抽象 Dirichlet 形式スタイル（軽量）
    ```lean
    structure Diffusion (X : Type*) where
      (E : (X → ℝ) → ℝ)           -- エネルギー（2 次形式）
      (L : (X → ℝ) → (X → ℝ))     -- 生成子
      (Gamma : (X → ℝ) → (X → ℝ)) -- Carré du champ、略式
      (Gamma2 : (X → ℝ) → (X → ℝ))
      -- 公理（Leibniz など）は最小限（将来拡張）

    def Doob (h : X → ℝ) (D : Diffusion X) : Diffusion X := ... -- L^h

    theorem doob_gamma_eq (h>0) : (Doob h D).Gamma = D.Gamma := by admit
    theorem doob_gamma2_eq (h>0) :
      (Doob h D).Gamma2 f = D.Gamma2 f - 2 * Hess (log h) ▷ (∇f ⊗ ∇f) := by admit
    ```
  - Euclid 版（R^n）では `∇, ∇^2` を `Mathlib/Analysis/Calculus` の導関数で書く計画。

- D2: Young L2 と剛性
  - 畳み込みの定義（ℝ: 実測度、ℤ: 列と ℓ¹ 測度）
    ```lean
    noncomputable def convR (f : ℝ → ℂ) (ν : Measure ℝ) : ℝ → ℂ := ...
    noncomputable def convZ (a : ℤ → ℂ) (μ : ℤ → ℂ) : ℤ → ℂ := ...
    ```
  - 不等式
    ```lean
    theorem young_L2_R (f) (ν) : ‖convR f ν‖₂ ≤ ‖f‖₂ * TVNorm ν
    theorem young_L2_Z (a) (μ) : ‖convZ a μ‖_{ℓ2} ≤ ‖a‖_{ℓ2} * ‖μ‖_{ℓ1}
    ```
  - 等号剛性（位相整合）
    ```lean
    theorem young_rigidity_R :
      (∃ f ≠ 0, ‖convR f ν‖₂ = ‖f‖₂ * TVNorm ν)
        ↔ (ν = phase * Dirac s0)
    theorem young_rigidity_Z : ...
    ```
    - Fourier 補助
      ```lean
      lemma triangle_equality_condition :
        (|∫ e^{-iξx} dν| = ∫ d|ν|) →
        (∃ φ, e^{-iξx} = e^{iφ} |ν|-a.e.)
      ```

- D3: Dirac 指数（仕様）
  ```lean
  structure DiracSystem where
    (M : Type*) [IsTorus2 M]
    (bundle : ComplexVectorBundle M)
    (A : UnitConnection bundle)

  theorem index_invariance_zero_order (S : DiracSystem)
      (V : ZeroOrderBoundedOp S.bundle) :
      index (D_prin^A + V_offdiag) = index (D_prin^A)

  theorem index_formula_T2 (S : DiracSystem) :
      index (D_F^A) = (1/(2*Real.pi*Complex.I)) * ∫∫_T2 Tr F_{θτ}
  ```
  - 現段階は「型の設計」と「注釈」。実実装は将来の `geometry` 依存拡張が前提。

## 4. 実装手順（Tasks）

1) DoobTransform スケルトン
- `Diffusion` 構造体（極小公理）と `Doob` 変換の定義シェルを作成。
- Euclid 版に寄せた補題（`Γ^h=Γ` 等）はステートメントを置き、必要な微分演算のラッパを TODO として抽出。

2) YoungConvolution
- ℝ: 有限全変動測度との畳み込みの型を決め、`L2` 上の有界性ステートメント。
- ℤ: ℓ¹–ℓ² の Young 不等式（mathlib 既存の利用も検討）。
- 剛性: Fourier 等号条件の補題を分離して段階実装（まず `ν` が純位相×Dirac なら等号 → 逆向き）。

3) DiracIndex（仕様）
- `DiracSystem` と主要定理の宣言のみ作成。詳証はスキップ（設計段階）。
- 参考文献・注釈コメントを充実させる。

## 5. 依存関係と影響範囲

- 依存: `MeasureTheory`, `Fourier`, `Topology`, `Calculus`（軽量採用）。
- 影響: 新規ファイルの追加（当面はビルドに障害を出さないため、定理は未追加か仮定パックのみ）。

## 6. 受入基準（Acceptance Criteria）

- AC1: Doob 変換の API スケルトン（構造体・関数定義・主要ステートメント）が追加される。
- AC2: Young L2 の不等式ステートメントが G=ℝ, ℤ で配置される（剛性は片方向からでも可）。
- AC3: Dirac 指数の仕様ファイルが追加され、定理の型と前提が明確化されている。
- AC4: CI は通る（重い証明を未投入／`sorry` 非使用）。

## 7. リスクと緩和

- R1: Doob の微分演算（∇, Hess）が重い
  - 緩和: まず抽象 `Diffusion` で API を固定し、Euclid 専用は将来実装。
- R2: Young 剛性の両方向証明が長くなる
  - 緩和: 片方向（Dirac ⇒ 等号）から先に、逆向きは補助補題を積み上げ段階的に。
- R3: Dirac の幾何的定義が mathlib 範囲超過
  - 緩和: 仕様ファイルに留め、後続の外部ライブラリ採用や自作拡張を検討。

## 8. 命名規約とスタイル

- モジュール: `Analysis/DoobTransform`, `Analysis/YoungConvolution`, `Geometry/DiracIndex`。
- `@[simp]` は定義整理に限る。重い証明は分離。

## 9. マイルストーン

- M1: Doob API スケルトン
- M2: Young L2（ℝ/ℤ）ステートメント
- M3: Young 剛性（片方向）
- M4: Dirac 仕様
- M5: 文書整備

## 10. 実装メモ

- Doob 3 行導出（Euclid 版）
  ```text
  L^h f = h^{-1} L(h f)
  Γ^h(f) = 1/2(L^h f^2 - 2 f L^h f) = Γ(f)
  Γ_2^h(f) = Γ_2(f) - 2 ⟨∇^2 log h ∇f, ∇f⟩
  ```
- Young 剛性（位相整合）
  ```text
  |∫ e^{-iξx} dν| = ∫ d|ν| ⇒ e^{-iξx+iφ} が |ν|-a.e. 定数
  2 周波数で同時に成り立つ ⇒ 台が一点 ⇒ ν = e^{iφ} δ_{s0}
  ```
