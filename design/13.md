# フルーリオ幾何学 第八論文 実装詳細設計書（FG8 → Lean4）

バージョン: 1.0
対象: papers/m点幾何学8.md の Lean4 実装計画（PLFA＝EDE＝EVI＝JKO と安定性）
関連: design/10.md, design/11.md, design/12.md, papers/m点幾何学1-7.md, papers/m点幾何学8.md

## 0. 目的とスコープ

- 目的: FG8 の中核主張
  - PLFA（最小フルーリオ作用原理）＝EDE＝EVI＝JKO の同値
  - 有効収縮率の下界: `λ_eff ≥ (λ-2ε) - γ( c_*(σ)‖S_m‖_∞^2 + c_D(σ)‖Ξ_m‖ )`
  - JKO スキームの存在・収束（proper/l.s.c./coercive と λ_BE-半凸の下）
  - two-EVI（外力付き）・テンソル化（min 則）・多スケール（ℤ^m）則
  を Lean API として配置し、既存解析基盤（EVI/Mosco/Doob/m点）と接続する。
- スコープ: 証明は段階導入。Phase FG8 では statement/theorem スケルトンと型・述語・定数の接続を優先（`sorry/axiom` 不使用）
  - 既存: `Frourio/Analysis/EVI.lean`（EVI/Grönwall/同期/Mosco-skel）、`DoobTransform.lean`（Doob/CD-shift-skel）、`Geometry/(FGCore/MPointCalibration/FGTheorems).lean`。
  - 新設: FG8 専用の機能関数 `ℱ_{Λ,σ}` と PLFA/EDE/JKO のラッパ述語・同値 API。

## 1. 数学→Lean マッピング（最小核）

- m点記号と K 変換
  - `S_m(s)=∑_{i=1}^m α_i χ_i Λ_i^{-s}` は sup ノルムと線形性のみ使用。
  - `ν_ρ = 𝕂_σ ρ` は狭義連続 (K1′) と測地親和 (K4^m) を述語化。

- 機能関数
  - `ℱ_{Λ,σ}(ρ) := Ent_μ(ρ) + γ · 𝔇_{σ,m}(ρ)`
  - `𝔇_{σ,m}(ρ) := ∫ |S_m(σ+iτ)|^2 d(𝕂_σ ρ)(τ)`（実装では評価関数 `Dsigmam : X → ℝ` を抽象化）
  - Doob により `λ_BE := λ - 2ε`。

- 必要定数の抽象化（安全側）
  - `cStar σ : ℝ`、`cDoob σ : ℝ` をパラメタとして受け、`‖S_m‖_∞, ‖Ξ_m‖` と組み合わせて下界を述語化。

- 同値・安定性
  - PLFA/EDE/EVI/JKO は命題レベルの述語で統一し、既存 `EVIProblem` と接続。

## 2. 追加ファイルと API 設計

- A1: `Frourio/Analysis/FrourioFunctional.lean`
  - `structure KTransform (X) := (apply : X → (ℝ → ℝ))` などの重い定義は避け、軽量述語に分離。
  - `structure FrourioFunctional (X) [PseudoMetricSpace X] :=`
    - `Ent : X → ℝ`
    - `Dsigmam : X → ℝ`
    - `gamma : ℝ`
    - `F : X → ℝ := fun x => Ent x + gamma * Dsigmam x`
  - (K1′) 狭義連続・(K4^m) 測地親和の抽象述語:
    - `def K1prime (X) : Prop := True`（P0 では nontrivial 化の一部を D 部に反映）
    - `def K4m (X) : Prop := True`（同上。基本モデルに向けたフラグ）
  - Doob 由来の `λ_BE` と劣化項：
    - `def lambdaBE (λ ε : ℝ) : ℝ := λ - 2*ε`
    - `structure ConstantBudget := (cStar cD : ℝ)`
    - `def lambdaEffLowerBound (...) : Prop`（FG8 の枠組みでの下界不等式）

- A2: `Frourio/Analysis/PLFA.lean`
  - PLFA/EDE/JKO の抽象述語：
    - `def PLFA (F : X → ℝ) (ρ : ℝ → X) : Prop := ...`（作用の最小性を命題で抽象化）
    - `def EDE (F : X → ℝ) (ρ : ℝ → X) : Prop := ...`
    - `def JKO (F : X → ℝ) (ρ0 : X) : Prop := ...`（逐次最小化列の存在・収束をまとめた述語）
  - 同値まとめ（statement レベル）：
    - `def plfaEdeEviJko_equiv (F : X → ℝ) (λeff : ℝ) : Prop :=`
      `  (∀ ρ, PLFA F ρ ↔ EDE F ρ) ∧ (∀ ρ, EDE F ρ ↔ Frourio.IsEVISolution ⟨F, λeff⟩ ρ) ∧ ...`
  - two-EVI（外力）スケルトン：EVI 側の `eviSumWithError`/Grönwall API を再利用し、`η` 上界を仮定に切り出した述語 `TwoEVIWithForce` を追加。

- A3: `Frourio/Geometry/FG8.lean`
  - FG8 のまとめ窓口。
  - `structure FG8Data (X) [PseudoMetricSpace X] :=`
    - `base : FGData X`（既存 FG コア）
    - `Ssup : ℝ`（`‖S_m‖_∞` の外生パラメタ）
    - `XiNorm : ℝ`（`‖Ξ_m‖` の外生パラメタ）
    - `budget : ConstantBudget`
    - `eps : ℝ`（Doob 劣化用 `ε`）
  - 主命題（命名は statement/theorem 化両対応）
    - `def fg8_equiv (D : FG8Data X) : Prop`（PLFA＝EDE＝EVI＝JKO）
    - `def fg8_lambda_bound (D : FG8Data X) : Prop`（`λ_eff` 下界）
    - `def fg8_twoEVI (D : FG8Data X) : Prop`（外力付き two-EVI）
    - `def fg8_tensor_min (D₁ D₂) : Prop`（テンソル化 min 則）
    - `def fg8_multiscale (Λ α κ : Fin m → ℝ) (k : Fin m → ℤ) : Prop`（多スケール則）

- A4: 既存ファイルの最小追記
  - `Frourio/Geometry/FGTheorems.lean` に multi-scale 則の re-export か同居（`effectiveLambda` の m 点版ヘルパ追加）
  - `Frourio.lean` に新規モジュール import を追加（実装時）

## 3. 実装方針（Lean 具体）

- 型は `X` を抽象（`PseudoMetricSpace`）に保ち、`ρ : ℝ → X` を時間曲線として扱う。 Wasserstein・測度は直接実装せず、`Ent`/`Dsigmam` を評価関数として抽象化。
- Doob 劣化は `DoobAssumptions`（既存）からの `cd_parameter_shift` を介して `λ_BE` を選ぶ設計（現段階は不等式型）。
- `plfaEdeEviJko_equiv` は EVI 側の `EVIProblem` と `IsEVISolution` に写して命題として束ねる。証明は段階化（初期は Prop レベル結線）。
- JKO は `JKO (F) (ρ0)` を述語で与え、`proper/l.s.c./coercive` と `λ_BE`-半凸（抽象述語）を前提に存在・収束の形を保持。
- two-EVI は `Frourio.Analysis.EVI` の `eviSumWithError` と `gronwall_exponential_contraction_with_error_half` を再利用し、`η` を `FG8Data` から与える形に整理。

## 4. 受入基準（AC）

- AC1: `Frourio/Analysis/FrourioFunctional.lean` に `FrourioFunctional`, `lambdaBE`, `lambdaEffLowerBound` が定義され、Docstring に FG8 該当節を記載。
- AC2: `Frourio/Analysis/PLFA.lean` に `PLFA/EDE/JKO` の述語と `plfaEdeEviJko_equiv` が追加される（`Prop` 返し、`sorry/axiom` 不使用）。
- AC3: `Frourio/Geometry/FG8.lean` に FG8 の主命題（同値・下界・two-EVI・テンソル化・多スケール）が揃い、`Frourio.lean` から到達可能。
- AC4: 既存 API 非破壊、既存ファイルのビルド維持。
- AC5: 新規モジュール先頭に 3–5 行の証明方針を Docstring で記す。

## 5. 実装手順（短期 D タスク）

- D1: Functional 基盤（A1）
  - `FrourioFunctional` と `lambdaBE`、`ConstantBudget`、`lambdaEffLowerBound` を追加。
  - (K1′)/(K4^m) は最小の非自明述語に置換（`True` からの脱却：少なくとも `Ssup ≥ 0` や `Dsigmam` の連続性など 1 フィールド依存）。
- D2: PLFA/EDE/JKO（A2）
  - `PLFA/EDE/JKO` 述語と `plfaEdeEviJko_equiv` の statement を追加。two-EVI 外力述語も追加。
- D3: FG8 窓口（A3）
  - `FG8Data` と主命題の statement 群を追加。`effectiveLambda` の m 点版（多スケール）ヘルパを併設。
- D4: 再エクスポートと import（A4）
  - `Frourio.lean` へ import 追加、`FGTheorems` で必要なら alias を再輸出。

## 6. リスクと緩和

- 測度論の重さ: Wasserstein/積分は抽象化し、`Ent`/`Dsigmam` を評価関数で代替。PLFA/EDE/JKO は述語で結線。
- Doob の仮定: `DoobAssumptions` の枠で `λ_BE` を安全側不等式として保持、将来 `∇² log h` 明示型へ強化。
- (K4^m) の Lean 化: 基本モデル（Zak–Mellin）から先行、一般は述語で保持し段階的に定理化。

## 7. マイルストーン

- M1: D1 完了（基盤 API）
- M2: D2 完了（同値述語の結線）
- M3: D3 完了（FG8 窓口・多スケール則）
- M4: D4 完了（統合と CI スモーク：`Frourio.lean` import 通過）

## 8. 参考・対応関係（Docstring 指示）

- FG8 §0–1 → A1（Functional と λ_BE・強上界の抽象化）
- FG8 §2 → A2（PLFA＝EDE＝EVI＝JKO の同値述語）
- FG8 §3 → A2/A3（JKO 述語と極限）
- FG8 §4 → A2/A3（two-EVI・テンソル化・多スケール）
- FG8 付録 → 将来の非自明化タスク（(K4^m) 基本モデル・l.s.c./緊性・定数分離）

---

本詳細設計は、FG8 の数理主張を Lean で安全側に抽象化しつつ、既存 EVI/Doob/m点 API と自然に結線するための最小核を提示する。証明強化（同値の theorem 化、(K4^m) の一般化、Doob パラメタの明示式）は次フェーズで行う。
