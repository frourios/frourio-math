# フルーリオ代数学 LEAN4実装 第7フェーズ設計書（P4 詳細）

バージョン: 1.0
対象期間: Phase P4（抽象 EVI フレーム／収縮／二解和／Mosco スケルトン）
担当: 開発/形式化チーム

## 0. 目的とスコープ

- 目的: 距離空間における抽象 EVI（Evolution Variational Inequality）の最小核を形式化し、
  - 収縮（同一生成子の二解が e^{-λ t} 収縮）
  - 二解 EVI の和に現れる mixed drift R の誤差評価付き不等式
  - 可変空間における Mosco 収束の「定義と EVI 継承ステートメント」
  を与える。
- スコープ: 解析的な正確性（測度論・下半連続性など）の証明は次フェーズ以降。ここでは型・公理・ステートメントを安定化（`sorry` は実装時に回避方針）。

## 1. 現状とギャップ

- 既存: 代数側（P0〜P3）と Mellin 側（P2）の設計が進行中。
- ギャップ: EVI の抽象層、収縮補題、Mosco 収束の枠組みが未整備。Doob 変換や MLSI と接続するための器が不足。

## 2. 成果物（Deliverables）

- D1: 抽象 EVI の定義（上側ディニ微分）
  - 距離空間 `(X,d)` 上、汎関数 `E : X → ℝ ∪ {+∞}` と λ ∈ ℝ に対する EVI の述語
  - `EVI_λ(E,u) : Prop` として、任意の `v : X` に対し
    `1/2 d^+/dt d(u(t),v)^2 + λ d(u(t),v)^2 ≤ E v - E (u(t))` を満たす。

- D2: 収縮定理（同一生成子）
  - `u,v : ℝ≥0 → X` がいずれも `EVI_λ(E,·)` を満たすなら
    `d(u(t),v(t)) ≤ Real.exp (-λ * t) * d(u(0),v(0))`。

- D3: 二解の EVI を加えたときの mixed drift（誤差項）
  - `R(u_t,v_t)` に対し `|⟪R, \dot γ_t⟫| ≤ η` を仮定すると
    `1/2 d^+/dt d(u(t),v(t))^2 + λ d(u(t),v(t))^2 ≤ η`。
  - ここで `γ_t` は `u(t)` と `v(t)` を結ぶ最短路。存在は仮定（測地完備など）。

- D4: Mosco（Kuwae–Shioya 型）のスケルトン
  - 可変基盤（測度や等長写像）下での `(M1)` Γ-liminf と `(M2)` 回復列の定義。
  - EVI 継承のステートメント（JKO 極限の存在仮定・緊性・エントロピーの l.s.c. をまとめた仮定パック付き）。

- D5: 文書化
  - 連続／量子／離散のそれぞれへの適用見取り図を注記（型は抽象層で統一）。

## 3. 仕様（API/型：案）

以下、Lean/mathlib の用語に合わせて `PseudoMetricSpace X`（あるいは `EMetricSpace X`）を前提とする。

- D1: EVI の定義
  - 上側ディニ微分を外部から与える補助関数
    ```lean
    noncomputable def d2 (x y : X) : ℝ := (dist x y)^2
    def DiniUpper (φ : ℝ≥0 → ℝ) (t : ℝ≥0) : ℝ :=
      sInf { L | ∀ ε > 0, ∃ h ∈ Set.Ioi (0:ℝ), φ (t + h) ≤ φ t + (L + ε) * h }
    ```
  - EVI 述語
    ```lean
    structure EVIProblem (X : Type*) [PseudoMetricSpace X] where
      (E : X → ℝ)        -- 拡張実値は将来拡張（ここでは ℝ に固定）
      (λ_ : ℝ)

    def IsEVISolution {X} [PseudoMetricSpace X]
      (P : EVIProblem X) (u : ℝ≥0 → X) : Prop :=
      ∀ (t : ℝ≥0) (v : X),
        (1/2 : ℝ) * DiniUpper (fun τ => d2 (u τ) v) t
          + P.λ_ * d2 (u t) v ≤ P.E v - P.E (u t)
    ```

- D2: 収縮定理
  ```lean
  theorem evi_contraction {X} [PseudoMetricSpace X]
      (P : EVIProblem X) {u v : ℝ≥0 → X}
      (hu : IsEVISolution P u) (hv : IsEVISolution P v) :
      ∀ t, dist (u t) (v t) ≤ Real.exp (- P.λ_ * (t : ℝ)) * dist (u 0) (v 0)
  ```
  - 証明方針: 標準手法（`φ(t)=1/2 d^2` へ微分不等式 → Grönwall）。

- D3: 二解和と誤差項
  ```lean
  structure MixedDrift (X : Type*) [PseudoMetricSpace X] where
    (η : ℝ)
    (bound : ∀ t, |⟪R t, γ̇ t⟫| ≤ η) -- 記法的。実装では仮定を述語で与える

  theorem evi_sum_with_error {X} [PseudoMetricSpace X]
      (P : EVIProblem X) {u v : ℝ≥0 → X}
      (hu : IsEVISolution P u) (hv : IsEVISolution P v)
      (hgeo : isGeodesicBetween u v) -- 測地存在の仮定（述語）
      (hR : MixedErrorBound u v)     -- 誤差項の上界仮定
      : ∀ t,
        (1/2 : ℝ) * DiniUpper (fun τ => d2 (u τ) (v τ)) t
          + P.λ_ * d2 (u t) (v t) ≤ hR.η
  ```
  - 実装では `MixedErrorBound` を `∀ t, |...| ≤ η` の述語型で定義。

- D4: Mosco スケルトン
  ```lean
  structure MoscoSystem where
    (Xh : Type*) (X : Type*)
    [hx : ∀ h, PseudoMetricSpace (Xh h)] [x : PseudoMetricSpace X]
    (Th : ∀ h, Xh h → X)  -- 比較写像（双リプシッツ仮定などを別述語で）
    (Eh : ∀ h, Xh h → ℝ) (E : X → ℝ)

  structure MoscoAssumptions (S : MoscoSystem) : Prop :=
    (geodesic_complete : ∀ h, GeodesicComplete (Xh h))
    (tightness : Tightness S)           -- 緊性（略）
    (lsc_Ent : LowerSemicontinuousAlong S.Th S.Eh S.E) -- Ent の l.s.c.
    (M1 : ΓLiminf S) (M2 : RecoverySeq S)

  theorem evi_inheritance (S : MoscoSystem)
      (H : MoscoAssumptions S) :
      liminf_LSI S ≥ inf_h LSI(S.h) ∧ liminf_T2 S ≥ inf_h T2(S.h) ∧
      EVI_inherited S
  ```
  - 上記は設計上の骨子であり、実装時には指標定数／評価の取り扱いを単純化する。

## 4. 実装手順（Tasks）

1) EVIProblem/IsEVISolution の定義とドキュメント（D1）
- Dini 上側微分の最小実装（集合下限定義）。`@[simp]` は付与しない。

2) 収縮定理のステートメントと証明（D2）
- Grönwall 型の補題利用（必要なら局所的に導入）。

3) 二解和＋誤差項のステートメント（D3）
- 測地存在と誤差上界を述語で分離。証明は EVI 二本の加算→中間項吸収の標準手順。

4) Mosco スケルトン（D4）
- 構造体と仮定パックを定義。EVI 継承はステートメントのみでも可（将来の解析基盤待ち）。

5) 文書化（D5）
- 連続/量子/離散への適用の見取り図をコメント節で提供。

## 5. 依存関係と影響範囲

- 依存: `Topology`, `Analysis` の軽量部分。測度論・変分収束の重い補題は未使用。
- 影響: 新規ファイル追加予定 `Frourio/Analysis/EVI.lean`（設計）。既存コードに破壊なし。

## 6. 受入基準（Acceptance Criteria）

- AC1: `EVIProblem` と `IsEVISolution` の定義が追加されている。
- AC2: 収縮定理 `evi_contraction` が型チェック可能な形で配置（証明の有無は段階的）。
- AC3: 二解和＋誤差項の不等式がステートメント化されている。
- AC4: Mosco スケルトンの構造体と仮定パックが定義済み。
- AC5: CI が通る（定義中心、重い証明は後回し）。

## 7. リスクと緩和

- R1: Dini 微分のテクニカルな取り扱いが複雑
  - 緩和: まずは定義と基本補題のみに留め、証明は後続フェーズで段階的に。
- R2: Mosco 仮定の表現が過度に一般的になり型が重くなる
  - 緩和: 最小限の述語に留め、将来の具体化（連続/量子/離散）で詳細化。
- R3: 量子・離散を同一抽象で扱う難度
  - 緩和: 本フェーズは連続的距離空間を主対象に抽象化し、量子/離散は注釈でガイドのみ。

## 8. 命名規約とスタイル

- 命名: `EVIProblem`, `IsEVISolution`, `evi_contraction`, `evi_sum_with_error`, `MoscoSystem`, `MoscoAssumptions`。
- コメントで「定義」「仮定」「用途」を明示。`@[simp]` は避ける。

## 9. マイルストーン

- M1: D1（EVI 定義）
- M2: D2（収縮定理）
- M3: D3（二解和＋誤差）
- M4: D4（Mosco スケルトン）
- M5: D5（文書整備）

## 10. 実装メモ

- 収縮の標準導出
  ```lean
  -- φ(t) := 1/2 d(u(t),v(t))^2
  -- φ^+(t) + 2λ φ(t) ≤ 0 ⇒ φ(t) ≤ e^{-2λ t} φ(0)
  -- dist(u(t),v(t)) ≤ e^{-λ t} dist(u(0),v(0))
  ```
- 二解和の誤差項
  ```lean
  -- 2 本の EVI を (u,v) で相互に評価して加算
  -- 交差項 ⟨R, γ̇⟩ を |·| ≤ η で吸収
  -- ⇒ φ^+(t) + 2λ φ(t) ≤ 2η
  ```
