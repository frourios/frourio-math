# FG8/Frourio 変分原理 実装計画（P19・残タスク集約）

本書類は、`papers/*.md` と現状の Lean 実装（`Frourio/*`）を精読した上で、
フルーリオ数学における変分原理（PLFA＝EDE＝EVI＝JKO）の証明を完遂するための残タスクを、
依存関係と実装観点で整理した設計メモである。P18 を継承し、変分原理の実証に直結する項目を優先順位付きで具体化する。

## ゴール（到達判定）
- PLFA＝EDE＝EVI＝JKO 同値の Lean 定理を、`Frourio/Analysis/*` に実装。
- Grönwall・Dini 微分の基礎補題を「述語ラッパ」から「証明付き定理」へ置換。
- two‑EVI（誤差付き）および距離二乗→距離の橋渡しを、with‑error 版まで含め完了。
- 最小機能のフラグ（HalfConvex, StrongUpperBound）をフルーリオ汎関数 F に供給し、同値ルートを閉じる。
- `lake build` 完走（警告は設計上の占位 True のみ許容）。

## 現状サマリ（コード別）
- `Frourio/Analysis/EVI.lean`
  - Dini 上側微分：`shift`/`add_const` は証明済み。`additivity`，`time‑rescale`，Grönwall（均質/非均質）は述語 `…_pred` を介したラッパ段階。
  - 収縮：二乗距離→距離の橋渡し（`bridge_concrete`）は証明済み。自明ケース（自己収縮）もあり。二乗距離の微分不等式→Grönwall→収縮の流れは、前段の述語入力に依存。
  - two‑EVI/with‑error：骨格（`MixedErrorBound`，`eviSumWithError`）はあるが、測地一様評価や非同次 Grönwall からの距離版までは未結線（占位述語）。
  - Mosco：`MoscoSystem/M1/M2/Tight` と `EVILimitHolds` は最小骨格（多数が True/Prop 占位）。
- `Frourio/Analysis/PLFACore.lean`
  - 非距離部：PLFA⇒EDE は証明済み（上側ディニ微分の単調性）。EDE のシフト/前進差は証明済み。`jko_to_ede_from_flags` も実装済み。
  - フラグ類（Proper, LSC, Coercive, HalfConvex, StrongUpperBound, JKOStable）は占位（True）。
- `Frourio/Analysis/PLFA.lean`
  - Equiv パッケージ組み立て（flags→`plfaEdeEviJko_equiv`）は配線済み。`EDE_EVI_from_analytic_flags` は占位ルート（本質は EVI.lean の整備に依存）。
  - two‑EVI with force は EVI.lean の with‑error 連鎖に依存する形で薄く接続。
- `Frourio/Analysis/FrourioFunctional.lean`
  - F＝Ent＋γ·Dσm の導入、K 側からの作成、Doob 連携（λ_BE），係数の下界命題は占位だが API 固定済み。
  - slope は 0 ダミー。`StrongSlopeUpperBound_pred` はテンプレ。`AnalyticFlags` 生成も占位。
- `Frourio/Analysis/KTransform.lean`
  - K 変換の骨格と basic1D は用意。`K1′`/`K4^m` は占位。1D 線形補間での親和は証明済み。
- `Frourio/Analysis/DoobTransform.lean`
  - Doob 変換は API 骨格。`HasCD` は True。`cd_parameter_shift_explicit` などは占位証明。

## 残タスク（優先順・詳細）

### A. EVI/Dini/Grönwall（最優先）
- [ ] Dini 上側微分：`DiniUpper_add_le_pred` を定理化（右近傍 limsup の劣加法性）。
- [ ] 時間再標定：`DiniUpper_timeRescale_pred` を定理化（σ>0 のとき `D^+(φ∘(σ·)) = σ·(D^+φ)∘(σ·)`）。
- [ ] Grönwall（均質）：`gronwall_exponential_contraction_pred` を定理化し、`EVI.lean` 内の依存を差し替え。
- [ ] Grönwall（非同次・1/2 版）：`gronwall_exponential_contraction_with_error_half_pred` を定理化。
- [ ] 二解の EVI から `W(t)=d^2(u_t,v_t)` の微分不等式を導出（加算・交差項吸収）して、上の Grönwall へ接続。
  - 期待形：`(1/2)D^+W + λ·W ≤ 0`（誤差なし）／`≤ η`（with‑error）。

### B. 収縮の橋渡し（距離二乗→距離）
- [ ] with‑error 版の橋渡し述語 `HbridgeWithError` と距離版 `ContractionPropertyWithError` への整理（`PLFA.lean` の two‑EVI 連鎖と整合）。

### C. EDE⇔EVI の実体化（AGS 型の最小版）
- [ ] `EDE_EVI_from_analytic_flags` を証明化：仮定は `HalfConvex F λ_eff` と `StrongUpperBound F`（現段階では占位でも API 固定）。
- [ ] `PLFA.lean` の `EDE_EVI_pred`/`ede_evi_pred_from_core_flags` を、A/B の完成版に差し替え接続。

### D. JKO ⇒ PLFA/EDE/EVI（最短ルートの閉包）
- [ ] `PLFACore.lean` の `jko_to_ede_from_flags` を用いて、`PLFA.lean` で `jko_to_evi_from_flags` のルートを最終化（EDE⇔EVI 完了後）。
- [ ] `Examples.lean` に basic1D の最小サンプル（初期値→JKO→EDE/EVI 化）を追加。

### E. two‑EVI（外力）と with‑error 収縮
- [ ] 測地一様評価の Lean 述語（papers: two‑EVI の仮定）を `EVI.lean`/`PLFA.lean` で共有化。
- [ ] `eviSumWithError` → 非同次 Grönwall → `ContractionPropertySqWithError` → 橋渡し → `ContractionPropertyWithError` の鎖を、占位述語なしで接続。
- [ ] `PLFA.lean` の `twoEVIWithForce_to_distance_concrete(_closed)` を A/B 完了版に更新。

### F. フラグ（F＝Ent＋γ·Dσm）と slope
- [ ] slope の定義を「降下スロープ」へ差し替え可能な形へ抽象化（現状 0 のダミー）し、`StrongSlopeUpperBound_pred` を実体化。
- [ ] K 側の (K1′)/(K4^m) から、`AnalyticFlags F`（Proper/LSC/Coercive/HalfConvex/StrongUpperBound/JKOStable）を最小仮定で付与（占位を徐々に置換）。
- [ ] 最低限、変分原理の同値に必要な箇所のみ先行証明（全面置換は後続）。

### G. Mosco（本件の必須範囲のみ）
- [ ] 変分原理のコアには不要だが、後続の安定性に備え `EVILimitHolds` で使う M1/M2/Tight の十分条件（Entropy 下界、Dirichlet liminf/recovery）のラッパを追加（EVI 継承の API を固定）。

## 依存関係と実装順
1) A（Dini/Grönwall/二解からの W 不等式）
2) B（橋渡し with‑error まで）
3) C（EDE⇔EVI 実体化）
4) D（JKO ルート閉包・サンプル）
5) E（two‑EVI with‑error）
6) F（slope/flags の置換強化）
7) G（Mosco の最小十分条件）

## 受け入れ基準（Definition of Done）
- `lake build` 完走、型エラーなし。占位 True/Prop の残存は設計メモに明示。
- `plfaEdeEviJko_equiv F λ_eff` を `build_package_from_*` ルートで構成でき、`papers/m点幾何学8.md` の定理 2.1/3.2 に一致。
- EVI 収縮：二乗距離版と距離版（with/without‑error）の両方が `EVI.lean` で完結（外部述語なし）。
- `Examples.lean` に最小サンプル（basic1D）を追加し、ルート（JKO→PLFA/EDE→EVI）が実行可能であることを確認。

## 実装メモ（具体的技術）
- Dini の劣加法性：`limsup (a_n+b_n) ≤ limsup a_n + limsup b_n` と右近傍フィルタ `nhdsWithin (0) (Ioi 0)` の単調性で実装。
- 時間再標定：`(φ∘(σ·))` の差商に対し `h↘0+` での置換 `h ↦ h/σ` を使う（`σ>0` 仮定）。
- Grönwall：Mathlib の既存補題があれば活用。なければ Dini 版を自作（`W` 局所可積分性不要の limsup 版）。
- 二解の和：`IsEVISolution` を `v` へ適用した式と対称式を加算し、交差項を Young/Cauchy–Schwarz で吸収（papers 第八論文 §4/付録D の形）。
- 橋渡し with‑error：`Real.sqrt` の単調性＋`√(ab)=√a√b`＋`√(exp(x))=exp(x/2)` を既存補題で機械的に変形（EVI.lean に類似パターンあり）。

以上。
